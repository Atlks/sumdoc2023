mq 消息丢失问题


消息在消息队列RocketMQ版服务器保存多长时间？https://www.alibabacloud.com › help › latest › how-lon...
如果消息存储时长超过3天，无论消息是否已被消费，都会被删除。建议配置监控报警实时监控消费进度，并根据报警信息人工介入处理。

开启持久化

、死信队列设置
消息过期后会进入死信队列，如不想抛弃死信队列，默认进入ACTIVEMQ.DLQ队列，且不会自动清除；对于过期的消息进入死信队列还有一些可选的策略:放入各自的死信通道、保存在一个共享的队列（默认），且可以设置是否将过期消息放入队列的开关以及死信队列消息过期时间。


3、慢消费者策略设置
Broker将会启动一个后台线程用来检测所有的慢速消费者，并定期关闭关闭它们;中断慢速消费者，慢速消费将会被关闭。abortConnection是否关闭连接;如果慢速消费者最后一个ACK距离现在的时间间隔超过阀maxTimeSinceLastAck，则中断慢速消费者。
————————————————
mq如果丢失了数据，主要是因为你消费的时候，刚消费到，还没处理，结果进程挂了，比如重启了，那么就尴尬了，mq认为你都消费了，这数据就丢了。 这个时候得用mq提供的ack机制，简单来说，就是你关闭mq自动ack，可以通过一个api来调用就行，然后每次你自己代码里确保处理完的时候，再程序里ack一把。




3.如何防止消息丢失
（1）rabbitmq
A:生产者丢失消息
①：可以选择使用rabbitmq提供是事物功能，就是生产者在发送数据之前开启事物，
②：可以开启confirm模式。在生产者哪里设置开启了confirm模式之后
B:rabbitmq自己弄丢了数据 设置消息持久化到磁盘。设置持久化有两个步骤：


但是问题是，mq事务机制一搞，基本上吞吐量会下来，因为太耗性能。

事务机制和cnofirm机制最大的不同在于，事务机制是同步的，你提交一个事务之后会阻塞在那儿，但是confirm机制是异步的，你发送个消息之后就可以发送下一个消息，然后那个消息mq接收了之后会异步回调你一个接口通知你这个消息接收到了。

所以一般在生产者这块避免数据丢失，都是用confirm机制的。


（2）mq弄丢了数据
就是mq自己弄丢了数据，这个你必须开启mq的持久化，就是消息写入之后会持久化到磁盘，


保证消息不丢失是一个非常苛刻的要求，要保证消息不丢失就需要牺牲系统的性能(生产者的处理逻辑变复杂，MQ 的吞吐量降低，消费者消费速度下降等)，所以需要结合具体的业务场景来决定是不是需要百分百保证消息不丢失。通常而言，对于核心链路：如订单、交易等相关的业务，基本都需要保证保证消息百分百不丢失。