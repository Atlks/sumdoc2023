调用sql接口的幂等设计


二、重复数据产生原因总结

1.可能有其他程序（进程或线程）同时在操作数据

1、重复提交

用户注册，用户创建等操作，前端都会提交一些数据给后台服务，后台需要根据用户提交的数据在数据库中创建记录。如果后端收到了好几次提交，这时就会在数据库中重复创建了多条记录。这就是接口没有幂等性带来的 bug。

2、接口超时重试

对于给第三方调用的接口，有可能会因为网络原因而调用失败，这时，一般在设计的时候会对接口调用加上失败重试的机制。如果第一次调用已经执行了一半时，发生了网络异常。这时再次调用时就会因为脏数据的存在而出现调用异常。

3、消息重复消费

在使用消息中间件来处理消息队列，且手动 ack 确认消息被正常消费时。如果消费者突然断开连接，那么已经执行了一半的消息会重新放回队列。



三、解决方案

1.REPLACE sql语句来代替insert   简单方便 直接替换insert
2.merge语句   在 MySQL 中，不支持 MERGE，我们应用 INSERT…..ON DUPLICATE KEY UPDATE
3.程序语言catche捕获并丢弃数据库的 DUPLICATE KEY消息
4.触发器trigger等检查方案  遇到已有重复数据直接丢弃该sql
“插入前”触发器以检查条件并禁止。
5、一次性提交token 机制实现（复杂










阿里面试官：接口的幂等性怎么设计？-51CTO.COM